#!/usr/bin/env bash
set -e

BUNDLE_DIR=debug-bundle
ZIP_NAME=debug-bundle.zip
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")

echo "Creating debug bundle at $TIMESTAMP"

rm -rf $BUNDLE_DIR $ZIP_NAME
mkdir -p $BUNDLE_DIR/logs

# Core files
cp docker-compose.yml README.md $BUNDLE_DIR/

# Docker status
docker ps > $BUNDLE_DIR/docker-ps.txt

# Service logs (last 200 lines)
docker compose logs --tail=200 adapter > $BUNDLE_DIR/logs/adapter.log
docker compose logs --tail=200 entitlement > $BUNDLE_DIR/logs/entitlement.log
docker compose logs --tail=200 redis > $BUNDLE_DIR/logs/redis.log

# Correlation IDs used in recent logs
{
  echo "Timestamp: $TIMESTAMP"
  echo
  echo "Correlation IDs found in logs:"
  grep -R "correlation_id" $BUNDLE_DIR/logs || true
} > $BUNDLE_DIR/metadata.txt

# Zip it
zip -r $ZIP_NAME $BUNDLE_DIR >/dev/null

echo "Debug bundle created: $ZIP_NAME"

